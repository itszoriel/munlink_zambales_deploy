services:
  # Backend API (Python/Flask)
  - type: web
    name: munlinkzambales-api
    runtime: python
    rootDir: apps/api
    buildCommand: |
      pip install --no-cache-dir -r requirements.txt
      pip install --no-cache-dir psycopg2-binary==2.9.9
    startCommand: flask db upgrade && gunicorn app:app --bind 0.0.0.0:$PORT --workers 4 --timeout 120 --max-requests 1000 --max-requests-jitter 50
    healthCheckPath: /health
    envVars:
      - key: FLASK_ENV
        value: production
      - key: DEBUG
        value: "False"
      - key: FLASK_APP
        value: app.py
      - key: APP_NAME
        value: MunLink Zambales
      - key: SECRET_KEY
        sync: false
      - key: JWT_SECRET_KEY
        sync: false
      - key: JWT_COOKIE_SECURE
        value: "True"
      - key: JWT_COOKIE_SAMESITE
        value: None
      - key: COOKIE_DOMAIN
        value: munlinkapi.onrender.com
      - key: JWT_ACCESS_TOKEN_EXPIRES
        value: "86400"
      - key: ADMIN_SECRET_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: munlink-db
          property: connectionString
      - key: WEB_URL
        value: https://munlinkzambales-web.onrender.com
      - key: ADMIN_URL
        value: https://munlink-admin.onrender.com
      - key: BASE_URL
        value: https://munlinkapi.onrender.com
      - key: QR_BASE_URL
        value: https://munlinkzambales-web.onrender.com/verify
      - key: VERIFICATION_BASE_URL
        value: https://munlinkzambales-web.onrender.com
      - key: WEB_BASE_URL
        value: https://munlinkzambales-web.onrender.com
      - key: ADMIN_WEB_BASE_URL
        value: https://munlink-admin.onrender.com
      - key: UPLOAD_FOLDER
        value: uploads/zambales
      - key: MAX_FILE_SIZE
        value: "10485760"
      - key: ALLOWED_EXTENSIONS
        value: pdf,jpg,jpeg,png,doc,docx
      - key: SMTP_SERVER
        value: smtp.gmail.com
      - key: SMTP_PORT
        value: "587"
      - key: SMTP_USERNAME
        sync: false
      - key: SMTP_PASSWORD
        sync: false
      - key: FROM_EMAIL
        sync: false
      - key: CLAIM_CODE_ENC_KEY
        sync: false
      - key: CLAIM_JWT_SECRET
        sync: false
      - key: CLAIM_TOKEN_DAYS
        value: "14"
    disk:
      name: uploads
      mountPath: ./uploads
      sizeGB: 50  # Professional plan - increased for production uploads
    plan: standard  # Professional tier for no cold starts

  # Public Website (React/Vite)
  - type: web
    name: munlinkzambales-web
    runtime: static
    rootDir: apps/web
    buildCommand: npm ci && npm run build
    staticPublishPath: dist
    envVars:
      - key: VITE_API_URL
        value: https://munlinkapi.onrender.com

  # Admin Dashboard (React/Vite)
  - type: web
    name: munlink-admin
    runtime: static
    rootDir: apps/admin
    buildCommand: npm ci && npm run build
    staticPublishPath: dist
    envVars:
      - key: VITE_API_URL
        value: https://munlinkapi.onrender.com
      - key: VITE_API_BASE_URL
        value: https://munlinkapi.onrender.com

databases:
  - name: munlink-db
    databaseName: munlink_zambales
    user: munlink_user
    plan: starter  # Professional plan supports better DB options

